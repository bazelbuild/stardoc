---
matrix:
  platform:
    - ubuntu1804
    - ubuntu2004
    - macos

.common_flags: &common_flags
  ? "--incompatible_disable_starlark_host_transitions"

.noenable_bzlmod_flags: &noenable_bzlmod_flags
  <<: *common_flags
  ? "--noenable_bzlmod"

.windows_flags: &windows_flags
  <<: *common_flags
  # Workaround for https://github.com/bazelbuild/continuous-integration/issues/1012
  ? "--noexperimental_repository_cache_hardlinks"

.common_task_config: &common_task_config
  build_flags: *common_flags
  build_targets:
    - "//..."
  test_flags: *common_flags
  test_targets:
    - "//..."

.noenable_bzlmod_task_config: &noenable_bzlmod_task_config
  build_flags: *noenable_bzlmod_flags
  build_targets:
  # Note that //distro/... cannot be loaded in legacy WORKSPACE mode due to repo name change
    - "//:*"
    - "//src/..."
    - "//stardoc/..."
    - "//test/..."
  test_flags: *noenable_bzlmod_flags
  test_targets:
  # Some tests are expected to fail in legacy WORKSPACE mode due to repo name change
    - "//test/..."
    - "-//test:attribute_defaults_test_e2e_test"
    - "-//test:function_wrap_multiple_lines_test_e2e_test"
    - "-//test:misc_apis_test_e2e_test"
    - "-//test:module_extension_test_e2e_test"
    - "-//test:proto_format_test_e2e_test"
    - "-//test:stardoc_self_gen_test"
    - "-//test:table_of_contents_test_e2e_test"

.windows_task_config: &windows_task_config
  <<: *common_task_config
  build_flags: *windows_flags
  test_flags: *windows_flags

tasks:
  build_and_test:
    <<: *common_task_config
    name: Build and test
    platform: ${{ platform }}

  build_and_test_windows:
    <<: *windows_task_config
    name: Build and test - Windows
    platform: windows

  legacy_workspace:
    <<: *noenable_bzlmod_task_config
    name: Build and test - legacy WORKSPACE setup
    platform: ${{ platform }}

  build_and_test_last_green:
    <<: *common_task_config
    name: Build and test - Bazel last green
    platform: ${{ platform }}
    bazel: last_green

  build_and_test_last_green_windows:
    <<: *windows_task_config
    name: Build and test - Bazel last green - Windows
    platform: windows
    bazel: last_green

  bzlmod_usage:
    <<: *common_task_config
    name: Stardoc Bzlmod module usage test
    platform: ${{ platform }}
    working_directory: test/bzlmod

  bzlmod_usage_windows:
    <<: *windows_task_config
    name: Stardoc Bzlmod module usage test - Windows
    platform: windows
    working_directory: test/bzlmod

  bazel_7_1_tests:
    name: Stardoc golden tests requiring Bazel 7.1
    platform: ubuntu2004
    bazel: 7.1.2
    build_flags: *common_flags
    test_flags: *common_flags
    test_targets:
    - "//test:proto_format_test_e2e_test"

buildifier: latest
