---
matrix:
  platform:
    - ubuntu1804
    - ubuntu2004
    - macos

.common_flags: !!set &common_flags
  ? "--incompatible_disable_starlark_host_transitions"

.common_windows_flags: !!set &common_windows_flags
  <<: *common_flags
  # Workaround for https://github.com/bazelbuild/continuous-integration/issues/1012
  ? "--noexperimental_repository_cache_hardlinks"

.common_task_config: &common_task_config
  build_flags: *common_flags
  build_targets:
    - "//..."
  test_flags: *common_flags
  test_targets:
    - "//..."

.common_windows_task_config: &common_windows_task_config
  <<: *common_task_config
  build_flags: *common_windows_flags
  test_flags: *common_windows_flags

tasks:
  build_and_test:
    <<: *common_task_config
    name: Build and test
    platform: ${{ platform }}

  build_and_test_windows:
    <<: *common_windows_task_config
    name: Build and test - Windows
    platform: windows

  build_and_test_last_green:
    <<: *common_task_config
    name: Build and test - Bazel last green
    platform: ${{ platform }}
    bazel: last_green

  build_and_test_last_green_windows:
    <<: *common_windows_task_config
    name: Build and test - Bazel last green - Windows
    platform: windows
    bazel: last_green

  bzlmod:
    <<: *common_task_config
    name: Bzlmod example
    platform: ${{ platform }}
    working_directory: test/bzlmod
    build_flags: !!set
      <<: *common_flags
      ? "--enable_bzlmod"
    test_flags: !!set
      <<: *common_flags
      ? "--enable_bzlmod"

  bzlmod_windows:
    <<: *common_windows_task_config
    name: Bzlmod example - Windows
    platform: windows
    working_directory: test/bzlmod
    build_flags: !!set
      <<: *common_windows_flags
      ? "--enable_bzlmod"
    test_flags: !!set
      <<: *common_windows_flags
      ? "--enable_bzlmod"

buildifier: latest
